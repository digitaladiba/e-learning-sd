<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>LMS EduSmart Pro</title>
  
  <!-- Tailwind CSS & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Card Style */
    .card-modern { 
      background: white; border-radius: 16px; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
      border: 1px solid #e2e8f0; 
      transition: transform 0.2s;
    }
    .card-modern:active { transform: scale(0.98); }

    /* Gradient & Animasi */
    .hero-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Warna Medali Leaderboard */
    .medal-1 { color: #fbbf24; filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.4)); } /* Emas */
    .medal-2 { color: #94a3b8; filter: drop-shadow(0 2px 4px rgba(148, 163, 184, 0.4)); } /* Perak */
    .medal-3 { color: #d97706; filter: drop-shadow(0 2px 4px rgba(217, 119, 6, 0.4)); } /* Perunggu */
  </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col bg-slate-50">

  <!-- HEADER APLIKASI -->
  <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 sticky top-0 z-30">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md shadow-indigo-200">
        <i class="fas fa-shapes"></i>
      </div>
      <span class="font-bold text-slate-800 tracking-tight text-lg">EduSmart</span>
    </div>
    <div class="flex items-center gap-3">
      <div class="text-right hidden sm:block">
        <p id="headName" class="text-sm font-bold text-slate-800 leading-tight">User</p>
        <p id="headRole" class="text-[10px] text-slate-500 font-bold uppercase tracking-wide">Role</p>
      </div>
      <button onclick="doLogout()" class="w-9 h-9 bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition flex items-center justify-center border border-red-100">
        <i class="fas fa-power-off text-sm"></i>
      </button>
    </div>
  </header>

  <!-- CONTENT AREA (SCROLLABLE) -->
  <main id="mainContainer" class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 space-y-6 scroll-smooth">
    
    <!-- 1. DASHBOARD HOME (Umum) -->
    <div id="viewHome" class="fade-in space-y-6">
      <!-- Hero Card -->
      <div class="hero-gradient rounded-3xl p-6 text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-2xl font-bold">Halo, <span id="welcomeName">User</span>! üëã</h2>
            <p class="text-indigo-100 text-sm mt-1">Selamat datang di panel <span id="welcomeRole" class="font-bold">Belajar</span>.</p>
        </div>
        <i class="fas fa-rocket absolute -right-4 -bottom-4 text-8xl text-white/10 rotate-12"></i>
      </div>
      
      <!-- Statistik -->
      <div class="grid grid-cols-2 gap-4">
         <div class="card-modern p-5 text-center flex flex-col items-center justify-center gap-2">
            <i class="fas fa-chalkboard-teacher text-2xl text-orange-500 bg-orange-50 p-3 rounded-full"></i>
            <div>
                <span id="statGuru" class="text-xl font-bold block text-slate-800">0</span>
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Guru</span>
            </div>
         </div>
         <div class="card-modern p-5 text-center flex flex-col items-center justify-center gap-2">
            <i class="fas fa-user-graduate text-2xl text-blue-500 bg-blue-50 p-3 rounded-full"></i>
            <div>
                <span id="statSiswa" class="text-xl font-bold block text-slate-800">0</span>
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Siswa</span>
            </div>
         </div>
      </div>
    </div>

    <!-- 2. HALAMAN SISWA (Kelas & Nilai) -->
    <div id="viewSiswa" class="hidden fade-in space-y-6">
       <!-- Tab Menu Siswa -->
       <div class="flex gap-2 border-b border-slate-200 pb-2 overflow-x-auto no-scrollbar">
          <button onclick="switchSiswaTab('materi')" id="btnMat" class="whitespace-nowrap px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition">Materi</button>
          <button onclick="switchSiswaTab('tugas')" id="btnTug" class="whitespace-nowrap px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition">Tugas</button>
          <button onclick="switchSiswaTab('tka')" id="btnTka" class="whitespace-nowrap px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition">Ujian</button>
          <button onclick="switchSiswaTab('nilai')" id="btnNilai" class="whitespace-nowrap px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition">Rapor & Ranking</button>
       </div>
       
       <div id="siswaContent" class="space-y-4 min-h-[200px]">
           <!-- Konten akan dimuat di sini -->
       </div>
    </div>

    <!-- 3. HALAMAN GURU (Panel Admin) -->
    <div id="viewGuru" class="hidden fade-in space-y-6">
        <!-- Menu Grid Guru -->
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="showGuruInput('nilai')" class="col-span-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4 rounded-xl shadow-lg shadow-orange-200 font-bold text-sm flex items-center justify-center gap-2 active:scale-95 transition">
                <i class="fas fa-star text-lg"></i> INPUT NILAI SISWA
            </button>
            <button onclick="showGuruInput('siswa')" class="bg-white text-slate-700 border border-slate-200 p-3 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-50 transition">
                <i class="fas fa-users text-blue-500 text-lg"></i> Data Siswa
            </button>
            <button onclick="showGuruInput('upload')" class="bg-white text-slate-700 border border-slate-200 p-3 rounded-xl font-bold text-xs flex flex-col items-center gap-1 hover:bg-slate-50 transition">
                <i class="fas fa-cloud-upload-alt text-indigo-500 text-lg"></i> Upload Materi
            </button>
        </div>

        <!-- Panel Guru: Data Siswa -->
        <div id="guruPanelSiswa" class="hidden">
            <h3 class="font-bold text-slate-700 mb-2 border-l-4 border-blue-500 pl-2">Lihat Akun Siswa</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="cekKelasInput" placeholder="Kelas (Cth: 1A)" class="border border-slate-300 rounded-lg p-2 w-full text-sm font-bold uppercase text-center tracking-wider">
                <button onclick="loadDataSiswa()" class="bg-slate-800 text-white px-4 rounded-lg font-bold hover:bg-slate-700"><i class="fas fa-search"></i></button>
            </div>
            <div id="listSiswaContainer" class="space-y-2"></div>
        </div>

        <!-- Panel Guru: Upload Materi -->
        <div id="guruPanelUpload" class="hidden card-modern p-5 border-l-4 border-indigo-500">
            <h3 class="font-bold text-slate-800 mb-4 pb-2 border-b">Form Upload Materi</h3>
            <div class="space-y-3">
                <div class="bg-slate-50 p-1 rounded-xl flex">
                    <select id="upTipe" class="w-full bg-transparent p-2 text-sm font-bold outline-none">
                        <option value="materi">üìò Materi Pelajaran</option>
                        <option value="tugas">üìù Tugas / PR</option>
                        <option value="tka">üíª Ujian Online (TKA)</option>
                    </select>
                </div>
                <input id="upMapel" type="text" placeholder="Mapel (Cth: Matematika)" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 transition">
                <input id="upKelas" type="text" placeholder="Kelas (Cth: 1A)" class="w-full p-3 border rounded-xl text-sm uppercase font-bold outline-none focus:border-indigo-500 transition">
                <input id="upJudul" type="text" placeholder="Judul Materi" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 transition">
                <input id="upLink" type="text" placeholder="Link URL (Drive/Youtube)" class="w-full p-3 border rounded-xl text-sm text-blue-600 outline-none focus:border-indigo-500 transition">
                <input id="upExtra" type="text" placeholder="Deadline (YYYY-MM-DD) / Durasi" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-indigo-500 transition">
                
                <button onclick="submitData('upload')" id="btnSubmitUpload" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 mt-2">
                    <i class="fas fa-save"></i> SIMPAN DATA
                </button>
            </div>
        </div>

        <!-- Panel Guru: Input Nilai -->
        <div id="guruPanelNilai" class="hidden card-modern p-5 border-l-4 border-yellow-400">
            <h3 class="font-bold text-slate-800 mb-4 pb-2 border-b">Input Nilai Siswa</h3>
            <div class="space-y-3">
                <!-- Langkah 1 -->
                <div class="flex gap-2">
                    <input id="nilaiKelas" type="text" placeholder="Kelas (1A)" class="w-1/3 p-3 border rounded-xl text-sm uppercase font-bold text-center outline-none focus:border-yellow-500">
                    <button onclick="loadSiswaDropdown()" class="bg-slate-700 text-white px-4 rounded-xl text-xs font-bold w-2/3 hover:bg-slate-800">CARI SISWA</button>
                </div>
                
                <!-- Langkah 2 -->
                <select id="nilaiEmail" class="w-full p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-sm font-bold text-slate-700 outline-none">
                    <option value="">-- Pilih Siswa Dulu --</option>
                </select>

                <div class="grid grid-cols-2 gap-2">
                     <select id="nilaiKategori" class="w-full p-3 border rounded-xl text-sm outline-none">
                        <option value="Tugas">Tugas</option>
                        <option value="TKA">Ujian</option>
                        <option value="UTS">UTS</option>
                        <option value="UAS">UAS</option>
                    </select>
                    <input id="nilaiMapel" type="text" placeholder="Mapel" class="w-full p-3 border rounded-xl text-sm outline-none">
                </div>
                
                <input id="nilaiJudul" type="text" placeholder="Judul Tugas/Ujian" class="w-full p-3 border rounded-xl text-sm outline-none">
                
                <div class="relative">
                    <input id="nilaiAngka" type="number" placeholder="Nilai (0-100)" class="w-full p-3 border rounded-xl text-sm font-bold text-lg outline-none focus:border-yellow-500 pl-12">
                    <div class="absolute left-4 top-3 text-slate-400 font-bold">Score:</div>
                </div>
                
                <input id="nilaiCatatan" type="text" placeholder="Catatan Guru (Opsional)" class="w-full p-3 border rounded-xl text-sm outline-none">

                <button onclick="submitData('nilai')" id="btnSubmitNilai" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600 transition shadow-lg shadow-yellow-200 mt-2">
                    <i class="fas fa-check-circle"></i> SIMPAN NILAI
                </button>
            </div>
        </div>
    </div>

  </main>

  <!-- NAVIGATION BAR (BOTTOM) -->
  <nav class="bg-white border-t border-slate-200 fixed bottom-0 w-full h-16 flex justify-around items-center px-2 z-40 pb-safe">
     <button onclick="navTo('home')" id="navHome" class="nav-btn flex flex-col items-center gap-1 text-indigo-600 w-16 transition active:scale-95">
        <i class="fas fa-home text-lg"></i><span class="text-[10px] font-bold">Home</span>
     </button>
     
     <!-- Menu Tengah Berbeda Tergantung Role -->
     <button onclick="navTo('fitur')" id="navMid" class="nav-btn relative -top-6 w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-xl shadow-indigo-300 border-4 border-slate-50 transition active:scale-90 hover:bg-indigo-700">
        <i class="fas fa-book-open text-lg" id="iconMid"></i>
     </button>

     <button onclick="alert('Fitur Profil Segera Hadir!')" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-16 transition active:scale-95 hover:text-slate-600">
        <i class="fas fa-user text-lg"></i><span class="text-[10px] font-bold">Akun</span>
     </button>
  </nav>

  <!-- LOGIN MODAL -->
  <div id="loginOverlay" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-6">
    <div class="w-full max-w-sm text-center">
        <div class="w-24 h-24 bg-indigo-600 rounded-3xl mx-auto flex items-center justify-center text-white text-5xl mb-6 shadow-2xl shadow-indigo-300 rotate-6"><i class="fas fa-shapes"></i></div>
        <h1 class="text-2xl font-bold text-slate-800">EduSmart Login</h1>
        <p class="text-sm text-slate-500 mb-8">Portal Belajar Digital Terpadu</p>
        <div class="space-y-4">
            <div class="relative">
                <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400"></i>
                <input type="email" id="emailInput" class="w-full bg-slate-50 border border-slate-200 p-3 pl-10 rounded-xl font-bold text-slate-700 outline-none focus:border-indigo-500 transition" placeholder="Email Sekolah">
            </div>
            <button onclick="doLogin()" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition flex justify-center items-center gap-2">
                MASUK SEKARANG <i class="fas fa-arrow-right"></i>
            </button>
            <p id="loginMsg" class="text-red-500 text-xs font-bold min-h-[20px] mt-2"></p>
        </div>
    </div>
  </div>

<script>
// ==========================================
// CONFIGURASI API
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbx9R2KHLhCbyIthh1_j6MoZ_Xxohh99NYfvN4iTMEbaDdp-HG4ZI4zMjmVjdKfFn3aqaA/exec";

let USER = null;
const el = (id) => document.getElementById(id);

// ================= LOGIN SYSTEM =================
function doLogin(){
    const email = el('emailInput').value.trim();
    if(!email) return el('loginMsg').innerText = "Masukkan email dulu ya!";
    
    el('loginMsg').innerText = "Sedang memeriksa akun...";
    
    fetch(`${API_URL}?action=login&email=${email}`)
    .then(r => r.json())
    .then(d => {
        if(d.status){
            USER = d;
            el('loginOverlay').classList.add('hidden');
            initApp();
        } else {
            el('loginMsg').innerText = d.message;
        }
    })
    .catch(() => el('loginMsg').innerText = "Gagal terhubung ke server.");
}

function doLogout(){
    if(confirm("Yakin ingin keluar aplikasi?")) location.reload();
}

// ================= APP INITIALIZATION =================
function initApp(){
    el('welcomeName').innerText = USER.nama;
    el('headName').innerText = USER.nama;
    el('headRole').innerText = USER.role;
    
    // Setup UI Berdasarkan Role
    if(USER.role === 'guru'){
        el('welcomeRole').innerText = "Guru (Admin Kelas)";
        el('iconMid').className = "fas fa-cog text-xl"; // Icon Gear untuk Guru
        loadStatistik();
    } else {
        el('welcomeRole').innerText = "Ruang Belajar";
        el('iconMid').className = "fas fa-book-open text-xl"; // Icon Buku untuk Siswa
        loadStatistik();
    }
}

function navTo(page){
    // Hide All Pages
    ['viewHome', 'viewSiswa', 'viewGuru'].forEach(id => el(id).classList.add('hidden'));
    
    // Reset Nav Colors
    el('navHome').className = "nav-btn flex flex-col items-center gap-1 text-slate-400 w-16 transition active:scale-95";
    
    if(page === 'home'){
        el('viewHome').classList.remove('hidden');
        el('navHome').className = "nav-btn flex flex-col items-center gap-1 text-indigo-600 w-16 transition active:scale-95";
    } else if (page === 'fitur'){
        if(USER.role === 'guru'){
            el('viewGuru').classList.remove('hidden'); 
            showGuruInput('nilai'); // Default buka menu nilai untuk guru
        } else {
            el('viewSiswa').classList.remove('hidden'); 
            loadSiswaContent('materi'); // Default buka materi untuk siswa
        }
    }
}

// ================= LOGIKA SISWA =================
function switchSiswaTab(tab){
    // Reset Style Button
    ['btnMat', 'btnTug', 'btnTka', 'btnNilai'].forEach(id => el(id).className = "whitespace-nowrap px-4 py-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition");
    
    // Set Active Style
    const activeClass = "whitespace-nowrap px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition";
    if(tab==='materi') el('btnMat').className = activeClass;
    if(tab==='tugas') el('btnTug').className = activeClass;
    if(tab==='tka') el('btnTka').className = activeClass;
    if(tab==='nilai') el('btnNilai').className = activeClass;
    
    loadSiswaContent(tab);
}

function loadSiswaContent(type){
    el('siswaContent').innerHTML = `<div class="text-center py-10 opacity-50"><i class="fas fa-circle-notch fa-spin text-2xl text-indigo-500"></i><p class="text-xs mt-2">Memuat data...</p></div>`;
    
    if(type === 'tka'){
        fetch(`${API_URL}?action=tka&kelas=${USER.kelas}`).then(r=>r.json()).then(d=>{
            if(d.data.length){
                el('siswaContent').innerHTML = d.data.map(t => `
                    <div class="card-modern p-5 border-l-4 border-red-500 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <span class="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded uppercase tracking-wide"><i class="fas fa-clock"></i> ${t.durasi}</span>
                                <h4 class="font-bold text-slate-800 mt-2 text-lg leading-tight">${t.judul}</h4>
                                <p class="text-xs text-slate-500 mt-1">${t.mapel}</p>
                            </div>
                            <div class="w-10 h-10 bg-red-50 rounded-full flex items-center justify-center text-red-500"><i class="fas fa-laptop-code"></i></div>
                        </div>
                        <a href="${t.link}" target="_blank" class="block text-center bg-red-500 text-white text-sm font-bold py-3 rounded-xl mt-4 hover:bg-red-600 transition shadow-lg shadow-red-200">
                            MULAI UJIAN <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                `).join('');
            } else { el('siswaContent').innerHTML = emptyMsg("Tidak ada ujian aktif saat ini."); }
        });
    } else if (type === 'nilai') {
        // LEADERBOARD + NILAI
        Promise.all([
            fetch(`${API_URL}?action=nilai&email=${USER.email}`).then(r=>r.json()),
            fetch(`${API_URL}?action=leaderboard&kelas=${USER.kelas}`).then(r=>r.json())
        ]).then(([dNilai, dRank]) => {
            let html = "";
            
            // 1. Tampilkan Leaderboard
            if(dRank.data && dRank.data.length > 0){
                html += `<div class="bg-slate-900 rounded-2xl p-5 text-white mb-6 relative overflow-hidden shadow-xl shadow-slate-300">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                    <h3 class="font-bold text-sm mb-4 text-center uppercase tracking-widest text-yellow-400 border-b border-slate-700 pb-2"><i class="fas fa-trophy mr-1"></i> Top 3 Kelas ${USER.kelas}</h3>
                    <div class="flex justify-center items-end text-center gap-4">
                        ${dRank.data[1] ? `<div class="w-1/3"><i class="fas fa-medal text-3xl medal-2 mb-1"></i><p class="text-[10px] font-bold text-slate-300 truncate">${dRank.data[1].nama}</p><p class="text-xs font-bold">${dRank.data[1].rata}</p></div>` : ''}
                        <div class="w-1/3 mb-4"><i class="fas fa-medal text-5xl medal-1 mb-2 animate-bounce"></i><p class="text-xs font-bold text-yellow-300 truncate">${dRank.data[0].nama}</p><p class="text-sm font-bold bg-yellow-500 text-slate-900 px-2 rounded-full inline-block mt-1">${dRank.data[0].rata}</p></div>
                        ${dRank.data[2] ? `<div class="w-1/3"><i class="fas fa-medal text-3xl medal-3 mb-1"></i><p class="text-[10px] font-bold text-slate-300 truncate">${dRank.data[2].nama}</p><p class="text-xs font-bold">${dRank.data[2].rata}</p></div>` : ''}
                    </div>
                </div>`;
            }

            // 2. Tampilkan Nilai Sendiri
            if(dNilai.data && dNilai.data.length){
                html += dNilai.data.map(n => {
                    const warnaNilai = n.nilai >= 75 ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
                    const iconNilai = n.nilai >= 75 ? 'fa-smile-beam' : 'fa-frown-open';
                    return `
                    <div class="card-modern p-4 flex justify-between items-center mb-3">
                        <div>
                            <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-wide">${n.kategori} ‚Ä¢ ${n.mapel}</span>
                            <h4 class="font-bold text-slate-800 mt-1 text-sm">${n.judul}</h4>
                            <p class="text-xs text-slate-400 mt-1 italic">"${n.catatan || 'Tetap semangat!'}"</p>
                        </div>
                        <div class="w-12 h-12 ${warnaNilai} rounded-2xl flex flex-col items-center justify-center font-bold text-lg border-2 shadow-sm">
                            ${n.nilai}
                            <i class="fas ${iconNilai} text-[10px] opacity-70"></i>
                        </div>
                    </div>`;
                }).join('');
            } else { html += emptyMsg("Belum ada nilai yang dimasukkan guru."); }
            
            el('siswaContent').innerHTML = html;
        });

    } else {
        fetch(`${API_URL}?action=ruangkelas&kelas=${USER.kelas}`).then(r=>r.json()).then(d=>{
            if(type === 'materi'){
                if(d.materi.length){
                    el('siswaContent').innerHTML = d.materi.map(m => `
                        <a href="${m.link}" target="_blank" class="card-modern p-4 flex items-center gap-4 hover:bg-indigo-50 transition group border-l-4 border-indigo-500">
                            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center text-lg group-hover:scale-110 transition"><i class="fas fa-book-reader"></i></div>
                            <div><h4 class="font-bold text-sm text-slate-800">${m.judul}</h4><p class="text-xs text-slate-500">${m.mapel}</p></div>
                            <div class="ml-auto text-slate-300"><i class="fas fa-chevron-right"></i></div>
                        </a>
                    `).join('');
                } else { el('siswaContent').innerHTML = emptyMsg("Belum ada materi."); }
            } else if (type === 'tugas'){
                if(d.tugas.length){
                    el('siswaContent').innerHTML = d.tugas.map(t => `
                        <div class="card-modern p-4 border-l-4 border-purple-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-[10px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold uppercase">Tugas</span>
                                    <h4 class="font-bold text-sm mt-1 text-slate-800">${t.judul}</h4>
                                    <p class="text-xs text-slate-500 mt-0.5">${t.mapel}</p>
                                </div>
                                <div class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded"><i class="fas fa-stopwatch mr-1"></i> ${t.deadline}</div>
                            </div>
                        </div>
                    `).join('');
                } else { el('siswaContent').innerHTML = emptyMsg("Asik! Tidak ada tugas."); }
            }
        });
    }
}

// ================= LOGIKA GURU =================
function showGuruInput(panel){
    ['guruPanelSiswa', 'guruPanelUpload', 'guruPanelNilai'].forEach(id => el(id).classList.add('hidden'));
    
    if(panel === 'siswa') el('guruPanelSiswa').classList.remove('hidden');
    if(panel === 'upload') el('guruPanelUpload').classList.remove('hidden');
    if(panel === 'nilai') el('guruPanelNilai').classList.remove('hidden');
}

function loadDataSiswa(){
    const kls = el('cekKelasInput').value.toUpperCase();
    if(!kls) return alert("Masukkan nama kelas!");
    
    el('listSiswaContainer').innerHTML = "<p class='text-xs text-center text-slate-400'>Sedang mencari...</p>";
    fetch(`${API_URL}?action=getSiswa&kelas=${kls}`).then(r=>r.json()).then(d=>{
        if(d.data.length){
            el('listSiswaContainer').innerHTML = d.data.map((s, i) => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center text-sm shadow-sm">
                    <div>
                        <span class="font-bold text-slate-800 block text-xs">${i+1}. ${s.nama}</span>
                        <span class="text-[10px] text-slate-400 font-mono bg-slate-50 px-1 rounded">${s.email}</span>
                    </div>
                    <span class="bg-green-100 text-green-600 text-[9px] px-2 py-1 rounded-full font-bold">AKTIF</span>
                </div>
            `).join('');
        } else { el('listSiswaContainer').innerHTML = "<p class='text-sm text-red-500 text-center py-2'>Tidak ada siswa di kelas ini.</p>"; }
    });
}

function loadSiswaDropdown(){
    const kls = el('nilaiKelas').value.toUpperCase();
    if(!kls) return alert("Isi kelas dulu!");
    
    el('nilaiEmail').innerHTML = "<option>Memuat...</option>";
    
    fetch(`${API_URL}?action=getSiswa&kelas=${kls}`).then(r=>r.json()).then(d=>{
        if(d.data.length){
            let opts = `<option value="">-- Pilih Siswa (${d.data.length}) --</option>`;
            d.data.forEach(s => opts += `<option value="${s.email}">${s.nama}</option>`);
            el('nilaiEmail').innerHTML = opts;
        } else {
            alert("Tidak ada siswa di kelas ini");
            el('nilaiEmail').innerHTML = "<option>Kosong</option>";
        }
    });
}

function submitData(mode){
    let payload = {};
    let btnId = "";

    if(mode === 'upload'){
        btnId = "btnSubmitUpload";
        payload = {
            action: `simpan_${el('upTipe').value}`,
            mapel: el('upMapel').value,
            kelas: el('upKelas').value.toUpperCase(),
            judul: el('upJudul').value,
            link: el('upLink').value,
            deadline: el('upExtra').value,
            durasi: el('upExtra').value
        };
        if(!payload.mapel || !payload.kelas || !payload.judul) return alert("Data kurang lengkap!");
    } 
    else if (mode === 'nilai'){
        btnId = "btnSubmitNilai";
        payload = {
            action: "simpan_nilai",
            email: el('nilaiEmail').value,
            kategori: el('nilaiKategori').value,
            mapel: el('nilaiMapel').value,
            judul: el('nilaiJudul').value,
            nilai: el('nilaiAngka').value,
            catatan: el('nilaiCatatan').value
        };
        if(!payload.email || !payload.nilai || !payload.mapel) return alert("Pilih siswa dan isi nilai!");
    }

    el(btnId).innerText = "Menyimpan...";
    
    fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(r=>r.json()).then(d=>{
        el(btnId).innerText = "SIMPAN";
        if(d.status) {
            alert("‚úÖ Berhasil: " + d.message);
            if(mode === 'nilai') { 
                el('nilaiAngka').value = ""; 
                el('nilaiCatatan').value = ""; 
            } else {
                el('upJudul').value = "";
                el('upLink').value = "";
            }
        } else { alert("‚ùå Gagal: " + d.message); }
    });
}

// ================= UTILS =================
function loadStatistik(){
    fetch(`${API_URL}?action=home`).then(r=>r.json()).then(d=>{
        el('statGuru').innerText = d.statistik.guru;
        el('statSiswa').innerText = d.statistik.siswa;
    });
}
function emptyMsg(msg){ return `<div class="text-center py-10 text-slate-400 text-xs italic opacity-70 border-2 border-dashed border-slate-200 rounded-xl">${msg}</div>`; }
</script>
</body>
</html>