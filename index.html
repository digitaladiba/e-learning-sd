<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>LMS SDN 04 Taman</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #fdf4ff; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .btn-side-float { position: fixed; top: 50%; left: 0; transform: translateY(-50%); background: #c026d3; color: white; padding: 14px 10px 14px 6px; border-radius: 0 16px 16px 0; box-shadow: 4px 0 15px rgba(192, 38, 211, 0.4); z-index: 50; cursor: pointer; transition: all 0.2s; }
    .btn-side-float:active { transform: translateY(-50%) scale(0.9); }
    #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-100%); }
    #sidebar.open { transform: translateX(0); }
    .card-sd { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #fae8ff; }
    .hero-gradient { background: linear-gradient(135deg, #d946ef 0%, #4f46e5 100%); }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Embed Container */
    .embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 12px; margin-top: 10px; background: #f8fafc; border: 1px solid #e2e8f0; }
    .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .game-viewer { width: 100%; height: 500px; background: #fff; border: 2px solid #e879f9; border-radius: 12px; margin-top: 10px; overflow: hidden; position: relative; }
    .game-viewer iframe { width: 100%; height: 100%; border: none; }

    .medal-1 { color: #fbbf24; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    .medal-2 { color: #94a3b8; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    .medal-3 { color: #d97706; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    
    /* Filter Button Active State */
    .filter-btn.active { background-color: #d946ef; color: white; border-color: #d946ef; }
  </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col bg-slate-50">

  <!-- SIDEBAR -->
  <div id="sidebarToggle" class="hidden btn-side-float" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></div>
  <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl z-50 flex flex-col border-r border-fuchsia-100">
    <div class="p-6 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white flex justify-between items-center shadow-md">
        <div><h2 class="font-bold text-lg">Menu Utama</h2><p class="text-xs text-fuchsia-100 opacity-80">SDN 04 Taman</p></div>
        <button onclick="toggleSidebar()" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30"><i class="fas fa-times"></i></button>
    </div>
    <nav class="flex-1 overflow-y-auto p-4 space-y-1">
        <button onclick="navTo('home')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-home w-6 text-center text-blue-500"></i> Beranda</button>
        <button onclick="navTo('akademik')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-graduation-cap w-6 text-center text-fuchsia-500"></i> Akademik</button>
        <div id="menuGuruSide" class="hidden">
            <button onclick="navTo('nilaiGuru')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-star w-6 text-center text-orange-500"></i> Input Nilai</button>
        </div>
        <div id="menuSiswaSide" class="hidden">
            <button onclick="navTo('nilaiSiswa')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-trophy w-6 text-center text-yellow-500"></i> Nilai & Medali</button>
            <button onclick="navTo('mading')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-clipboard-list w-6 text-center text-purple-500"></i> Mading Kelas</button>
        </div>
        <button onclick="navTo('perpus')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-book-reader w-6 text-center text-teal-500"></i> Perpus Digital</button>
        <button onclick="navTo('berita')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-newspaper w-6 text-center text-blue-500"></i> Berita Sekolah</button>
        <button onclick="navTo('profil')" class="w-full text-left p-3 hover:bg-fuchsia-50 rounded-xl flex gap-3 items-center text-sm font-medium text-slate-600 hover:text-fuchsia-600"><i class="fas fa-user-circle w-6 text-center text-slate-500"></i> Profil Saya</button>
    </nav>
    <div class="p-4 border-t bg-fuchsia-50/50">
        <button onclick="doLogout()" class="w-full py-3 bg-red-100 text-red-600 rounded-xl font-bold text-sm hover:bg-red-200 transition">Keluar Aplikasi</button>
    </div>
  </aside>
  <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/30 z-40 hidden backdrop-blur-sm transition-opacity"></div>

  <!-- HEADER -->
  <header class="bg-white h-16 flex items-center justify-between px-6 border-b border-fuchsia-100 shadow-sm sticky top-0 z-20">
    <div class="flex items-center gap-2"><div class="w-8 h-8 bg-gradient-to-br from-fuchsia-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-md"><i class="fas fa-shapes"></i></div><span class="font-bold text-fuchsia-800 tracking-tight text-lg">SDN 04</span></div>
    <div class="flex items-center gap-2"><div class="text-right hidden sm:block"><p id="headName" class="text-xs font-bold text-slate-700">User</p><p id="headRole" class="text-[10px] text-fuchsia-500 font-bold uppercase">Role</p></div><div class="w-9 h-9 rounded-full bg-fuchsia-50 overflow-hidden border-2 border-fuchsia-200"><img id="headImg" src="" class="w-full h-full object-cover"></div></div>
  </header>

  <!-- KONTEN -->
  <main id="mainContainer" class="flex-1 overflow-y-auto p-5 pb-24 space-y-6 scroll-smooth bg-fuchsia-50/30">
    
    <!-- HOME -->
    <div id="viewHome" class="hidden fade-in space-y-5">
        <div class="hero-gradient rounded-3xl p-6 text-white shadow-lg shadow-fuchsia-200 relative overflow-hidden">
            <div class="relative z-10"><h2 class="text-2xl font-bold mb-2">Halo, <span id="welcomeName">Siswa</span>! üëã</h2><p class="text-fuchsia-50 text-sm font-medium">Selamat datang di Portal Digital SDN 04 Taman.</p></div>
            <i class="fas fa-rocket absolute -right-6 -bottom-6 text-9xl text-white/10 rotate-12"></i>
        </div>
        <div class="card-sd p-5 space-y-4 bg-white/80 backdrop-blur-sm border-fuchsia-100">
            <div class="flex items-center gap-3 border-b border-fuchsia-50 pb-3"><div class="w-10 h-10 bg-fuchsia-100 rounded-full flex items-center justify-center text-fuchsia-600"><i class="fas fa-school"></i></div><div><h3 class="font-bold text-slate-800" id="infoNama">SDN 04 TAMAN</h3><p class="text-xs text-slate-500" id="infoAlamat">Jl. Pendidikan...</p></div></div>
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-start gap-3"><div class="mt-1 text-blue-500"><i class="fas fa-user-tie"></i></div><div><h4 class="font-bold text-blue-700 text-xs uppercase mb-1">Operator Sekolah</h4><p class="text-xs text-slate-700 font-medium" id="infoOperator">Loading...</p></div></div>
            <div class="grid grid-cols-2 gap-3 text-xs"><div class="bg-white border border-slate-100 p-3 rounded-lg shadow-sm"><p class="font-bold text-slate-400 mb-1">Email</p><p class="font-medium text-slate-700 truncate" id="infoEmail">-</p></div><div class="bg-white border border-slate-100 p-3 rounded-lg shadow-sm"><p class="font-bold text-slate-400 mb-1">Website</p><p class="font-medium text-blue-500 truncate" id="infoWeb">-</p></div></div>
        </div>
        <div><h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fas fa-calendar-alt text-fuchsia-600"></i> Kalender Pendidikan</h3><div id="listKaldik" class="space-y-3"></div></div>
        <div><h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fas fa-bullhorn text-blue-600"></i> Info Terbaru</h3><div id="listPengumuman" class="space-y-3"></div></div>
    </div>

    <!-- BERITA -->
    <div id="viewBerita" class="hidden fade-in space-y-4"><h2 class="text-xl font-bold text-fuchsia-800">Berita & Pengumuman</h2><div id="listBerita" class="space-y-3"></div></div>

    <!-- PERPUS (KALDIK) -->
    <div id="viewPerpus" class="hidden fade-in space-y-6">
        <div><h2 class="text-lg font-bold mb-3 text-fuchsia-800 flex items-center gap-2"><i class="fas fa-calendar-alt"></i> Kalender Pendidikan</h2><div id="listKaldik" class="space-y-3"><div class="text-center py-6 border-2 border-dashed border-fuchsia-200 rounded-xl text-xs text-slate-400">Memuat Kaldik...</div></div></div>
        <div><h2 class="text-lg font-bold mb-3 text-blue-800 flex items-center gap-2"><i class="fas fa-book-reader"></i> Koleksi Pustaka</h2><div id="listPerpus" class="grid grid-cols-2 gap-3"></div></div>
    </div>

    <!-- AKADEMIK (FILTER AKTIF & HTML FIX) -->
    <div id="viewAkademik" class="hidden fade-in space-y-4">
        <h2 class="text-xl font-bold text-fuchsia-800">Akademik Terpadu</h2>
        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <button id="btnMateri" onclick="filterAkademik('Materi', 'btnMateri')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-blue-100 text-xs font-bold text-blue-600 hover:bg-blue-50 transition whitespace-nowrap shadow-sm">üìò Materi</button>
            <button id="btnTugas" onclick="filterAkademik('Tugas', 'btnTugas')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-orange-100 text-xs font-bold text-orange-600 hover:bg-orange-50 transition whitespace-nowrap shadow-sm">üìù Tugas</button>
            <button id="btnPR" onclick="filterAkademik('PR', 'btnPR')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-fuchsia-100 text-xs font-bold text-fuchsia-600 hover:bg-fuchsia-50 transition whitespace-nowrap shadow-sm">üè† PR</button>
            <button id="btnSumatif" onclick="filterAkademik('Sumatif', 'btnSumatif')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-red-100 text-xs font-bold text-red-600 hover:bg-red-50 transition whitespace-nowrap shadow-sm">üìä Sumatif</button>
            <button id="btnASAS" onclick="filterAkademik('ASAS', 'btnASAS')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-indigo-100 text-xs font-bold text-indigo-600 hover:bg-indigo-50 transition whitespace-nowrap shadow-sm">üìù ASAS</button>
            <button id="btnTKA" onclick="filterAkademik('TKA', 'btnTKA')" class="filter-btn px-4 py-2 rounded-xl bg-white border border-purple-100 text-xs font-bold text-purple-600 hover:bg-purple-50 transition whitespace-nowrap shadow-sm">üíª TKA</button>
        </div>
        <button id="btnTambahAkademik" onclick="showModalUpload()" class="hidden w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 mb-2 flex items-center justify-center gap-2 hover:bg-blue-700 transition">
            <i class="fas fa-plus-circle"></i> Tambah Konten Baru
        </button>
        <div id="listAkademik" class="space-y-3 min-h-[200px]"></div>
    </div>

    <!-- NILAI GURU -->
    <div id="viewNilaiGuru" class="hidden fade-in space-y-4"><div class="card-sd p-5 border-l-4 border-fuchsia-500 shadow-fuchsia-100"><h3 class="font-bold text-lg mb-4 text-fuchsia-800">Input Nilai Siswa</h3><div class="space-y-3"><div class="flex gap-2"><input id="inKelas" type="number" placeholder="Kelas" class="w-20 p-2 border border-fuchsia-200 rounded-lg text-center font-bold text-fuchsia-700 outline-none"><button onclick="loadSiswaDropdown()" class="flex-1 bg-fuchsia-600 text-white rounded-lg font-bold text-xs hover:bg-fuchsia-700 transition">Cari Siswa</button></div><select id="inSiswa" class="w-full p-2 border border-fuchsia-200 rounded-lg bg-fuchsia-50 font-bold text-fuchsia-800"><option>Pilih Siswa...</option></select><div class="grid grid-cols-2 gap-2"><select id="inKategori" class="w-full p-2 border border-fuchsia-200 rounded-lg text-sm"><option value="Sumatif">Sumatif</option><option value="Tugas">Tugas</option><option value="PR">PR</option><option value="ASAS">ASAS</option><option value="TKA">TKA</option></select><input id="inMapel" type="text" placeholder="Mapel" class="w-full p-2 border border-fuchsia-200 rounded-lg text-sm"></div><input id="inJudul" type="text" placeholder="Judul Penilaian" class="w-full p-2 border border-fuchsia-200 rounded-lg text-sm"><input id="inNilai" type="number" placeholder="Nilai (0-100)" class="w-full p-2 border border-fuchsia-200 rounded-lg font-bold text-lg text-fuchsia-600"><input id="inCatatan" type="text" placeholder="Saran / Catatan" class="w-full p-2 border border-fuchsia-200 rounded-lg text-sm"><button onclick="submitNilai()" id="btnSimpanNilai" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">SIMPAN NILAI</button></div></div></div>
    
    <!-- NILAI SISWA -->
    <div id="viewNilaiSiswa" class="hidden fade-in space-y-6"><div id="leaderboardArea" class="bg-slate-800 text-white rounded-2xl p-5 shadow-xl shadow-slate-300 text-center relative overflow-hidden"><div class="absolute top-0 left-0 w-32 h-32 bg-fuchsia-500 rounded-full blur-3xl opacity-20 -ml-10 -mt-10"></div><h3 class="font-bold text-yellow-400 uppercase tracking-widest text-xs mb-4 relative z-10">Papan Juara Kelas</h3><div id="top3Container" class="flex justify-center items-end gap-4 relative z-10"><p class="text-xs opacity-60">Memuat...</p></div></div><div class="space-y-3"><h3 class="font-bold text-fuchsia-800">Riwayat Nilai Saya</h3><div id="riwayatNilai" class="space-y-2"></div></div></div>
    
    <!-- MADING -->
    <div id="viewMading" class="hidden fade-in space-y-4"><h2 class="text-xl font-bold text-fuchsia-800">Mading Kelas</h2><div class="bg-white p-4 rounded-xl border border-fuchsia-100 shadow-sm"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center"><i class="fas fa-crown"></i></div><div><h3 class="font-bold text-slate-800">Bintang Kelas</h3><p class="text-xs text-slate-500">Nilai rata-rata tertinggi</p></div></div><div id="madingJuara" class="text-sm font-bold text-fuchsia-600 bg-fuchsia-50 p-3 rounded-lg text-center">Memuat juara...</div></div><div class="bg-white p-4 rounded-xl border border-blue-100 shadow-sm"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-bullhorn"></i></div><div><h3 class="font-bold text-slate-800">Info Sekolah</h3><p class="text-xs text-slate-500">Pengumuman terbaru</p></div></div><div id="madingInfo" class="space-y-2"></div></div></div>
    
    <!-- PROFIL -->
    <div id="viewProfil" class="hidden fade-in"><div class="text-center mt-6"><div class="w-24 h-24 bg-fuchsia-200 rounded-full mx-auto overflow-hidden border-4 border-white shadow-lg shadow-fuchsia-200"><img id="profilImg" src="" class="w-full h-full object-cover"></div><h2 id="profilNama" class="text-xl font-bold mt-3 text-fuchsia-900">Nama Siswa</h2><p id="profilRole" class="text-sm text-fuchsia-500 font-medium">Siswa Kelas -</p><div id="editProfilGuru" class="hidden mt-6 px-6"><p class="text-xs font-bold text-left mb-1 text-slate-500">Update Foto Profil (URL)</p><div class="flex gap-2"><input type="text" id="urlFotoGuru" placeholder="https://..." class="w-full p-2 border border-fuchsia-200 rounded-lg text-sm bg-white"><button onclick="updateFotoGuru()" id="btnSaveFoto" class="bg-fuchsia-600 text-white px-4 rounded-lg text-xs font-bold">Simpan</button></div></div></div></div>
  </main>

  <!-- MENU BAWAH -->
  <nav class="bg-white border-t border-fuchsia-100 h-16 fixed bottom-0 w-full flex justify-around items-center z-30 pb-1 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.03)]">
    <button onclick="navTo('home')" id="navBotHome" class="flex flex-col items-center w-16 text-slate-400 active:scale-95"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Home</span></button>
    <button onclick="navTo('akademik')" id="navBotAkd" class="flex flex-col items-center w-16 text-slate-400 active:scale-95"><i class="fas fa-book-open text-xl mb-1"></i><span class="text-[10px] font-bold">Akademik</span></button>
    <button onclick="navToMenuKhusus()" id="navBotKhusus" class="flex flex-col items-center w-16 text-slate-400 active:scale-95"><i id="iconBotKhusus" class="fas fa-star text-xl mb-1"></i><span id="labelBotKhusus" class="text-[10px] font-bold">Menu</span></button>
  </nav>

  <!-- MODAL UPLOAD -->
  <div id="modalUpload" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-5 w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-2xl">
        <h3 class="font-bold text-lg mb-4 text-fuchsia-800">Upload Konten</h3>
        <div class="space-y-3">
            <select id="upTipe" class="w-full p-2.5 bg-fuchsia-50 border border-fuchsia-100 rounded-xl font-bold text-sm text-fuchsia-800 outline-none"><option value="Materi">Materi</option><option value="Tugas">Tugas</option><option value="PR">PR</option><option value="Sumatif">Sumatif</option><option value="ASAS">ASAS</option><option value="TKA">TKA</option></select>
            <div class="grid grid-cols-2 gap-2"><select id="upKelas" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none"><option value="1">Kelas 1</option><option value="2">Kelas 2</option><option value="3">Kelas 3</option><option value="4">Kelas 4</option><option value="5">Kelas 5</option><option value="6">Kelas 6</option></select><select id="upMapel" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none"><option>Matematika</option><option>B. Indonesia</option><option>IPAS</option><option>PKN</option><option>PAI</option><option>PJOK</option><option>Seni</option><option>Inggris</option><option>Basa Jawa</option></select></div>
            <input id="upJudul" type="text" placeholder="Judul Konten" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none">
            <div class="relative"><i class="fas fa-link absolute left-3 top-3 text-slate-400 text-xs"></i><input id="upLink" type="text" placeholder="Link URL (Video/Drive)" class="w-full p-2.5 pl-8 border border-slate-200 rounded-xl text-sm text-blue-600 outline-none"></div>
            <div class="relative"><p class="text-[10px] text-slate-400 mb-1 ml-1 font-bold">Atau Paste Kode HTML Embed:</p><textarea id="upHtml" rows="3" class="w-full p-2.5 border border-slate-200 rounded-xl text-xs font-mono bg-slate-50 outline-none placeholder-slate-400" placeholder='<iframe src="..."></iframe>'></textarea></div>
            <div class="relative"><p class="text-[10px] text-slate-400 mb-1 ml-1 font-bold">Deadline:</p><input id="upDead" type="date" class="w-full p-2.5 border border-slate-200 rounded-xl text-sm outline-none text-slate-600"></div>
            <div class="flex gap-2 mt-4"><button onclick="document.getElementById('modalUpload').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-xl font-bold text-sm">Batal</button><button onclick="submitAkademik()" id="btnSimpanAkd" class="flex-1 bg-fuchsia-600 text-white py-2.5 rounded-xl font-bold text-sm hover:bg-fuchsia-700 shadow-md">Simpan</button></div>
        </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginOverlay" class="fixed inset-0 z-[60] bg-fuchsia-50 flex flex-col items-center justify-center p-6">
    <div class="text-center w-full max-w-xs bg-white p-8 rounded-3xl shadow-xl border border-fuchsia-100">
        <div class="w-20 h-20 bg-gradient-to-br from-fuchsia-500 to-purple-600 rounded-3xl mx-auto flex items-center justify-center text-white text-4xl mb-5 shadow-lg shadow-fuchsia-200 rotate-6"><i class="fas fa-shapes"></i></div>
        <h1 class="text-2xl font-bold text-fuchsia-900">E-Learning SD</h1>
        <p class="text-xs text-slate-500 mb-6">Portal Belajar Digital Terpadu</p>
        <div class="relative mb-4"><i class="fas fa-envelope absolute left-4 top-3.5 text-fuchsia-300"></i><input type="email" id="emailInput" class="w-full p-3 pl-10 border border-fuchsia-100 rounded-xl bg-fuchsia-50/50 text-sm font-bold text-slate-700 outline-none focus:border-fuchsia-400 focus:bg-white transition" placeholder="Email Sekolah"></div>
        <button onclick="doLogin()" class="w-full p-3 bg-fuchsia-600 text-white rounded-xl font-bold shadow-lg shadow-fuchsia-200 hover:bg-fuchsia-700 transition active:scale-95">MASUK SEKARANG</button>
        <p id="loginMsg" class="text-red-500 text-xs mt-3 font-bold h-4"></p>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx9R2KHLhCbyIthh1_j6MoZ_Xxohh99NYfvN4iTMEbaDdp-HG4ZI4zMjmVjdKfFn3aqaA/exec";
let USER = null;
const el = (id) => document.getElementById(id);

const savedUser = localStorage.getItem('lmsUserV4');
if(savedUser){
    USER = JSON.parse(savedUser);
    el('loginOverlay').classList.add('hidden');
    el('sidebarToggle').classList.remove('hidden');
    initApp();
}

function doLogin(){
    const email = el('emailInput').value.trim();
    if(!email) return el('loginMsg').innerText = "Email wajib diisi";
    el('loginMsg').innerText = "Memuat...";
    fetch(`${API_URL}?action=login&email=${email}`).then(r=>r.json()).then(d=>{
        if(d.status){
            USER = d;
            localStorage.setItem('lmsUserV4', JSON.stringify(d)); 
            el('loginOverlay').classList.add('hidden');
            el('sidebarToggle').classList.remove('hidden');
            initApp();
        } else { el('loginMsg').innerText = d.message; }
    });
}
function doLogout(){ if(confirm("Keluar dari aplikasi?")){ localStorage.removeItem('lmsUserV4'); location.reload(); } }

function initApp(){
    el('welcomeName').innerText = USER.nama;
    el('headName').innerText = USER.nama;
    el('headRole').innerText = USER.role;
    el('profilNama').innerText = USER.nama;
    el('profilRole').innerText = `${USER.role} ‚Ä¢ Kelas ${USER.kelas}`;
    let avatarUrl = "";
    if(USER.foto && USER.foto.startsWith("http")) avatarUrl = USER.foto; 
    else if(USER.role==='siswa') avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${USER.nama}`;
    else avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${USER.nama}`;
    el('headImg').src = avatarUrl; el('profilImg').src = avatarUrl;

    if(USER.role === 'guru' || USER.role === 'admin'){
        el('menuGuruSide').classList.remove('hidden');
        el('btnTambahAkademik').classList.remove('hidden');
        el('editProfilGuru').classList.remove('hidden');
        el('iconBotKhusus').className = "fas fa-star text-xl mb-1";
        el('labelBotKhusus').innerText = "Penilaian";
    } else {
        el('menuSiswaSide').classList.remove('hidden');
        el('iconBotKhusus').className = "fas fa-clipboard-list text-xl mb-1";
        el('labelBotKhusus').innerText = "Mading";
    }
    navTo('home');
}

function toggleSidebar(){ const sb = el('sidebar'); const ov = el('sidebarOverlay'); if(sb.classList.contains('open')){ sb.classList.remove('open'); ov.classList.add('hidden'); } else { sb.classList.add('open'); ov.classList.remove('hidden'); } }
function navTo(page){
    ['viewHome','viewAkademik','viewNilaiGuru','viewNilaiSiswa','viewMading','viewPerpus','viewProfil','viewBerita'].forEach(id=>el(id).classList.add('hidden'));
    el('sidebar').classList.remove('open'); el('sidebarOverlay').classList.add('hidden');
    ['navBotHome','navBotAkd','navBotKhusus'].forEach(id => el(id).className = "flex flex-col items-center w-16 text-slate-400 transition active:scale-95");

    if(page==='home'){ el('viewHome').classList.remove('hidden'); el('navBotHome').className = "flex flex-col items-center w-16 text-fuchsia-600 transition active:scale-95"; loadHome(); }
    else if(page==='akademik'){ el('viewAkademik').classList.remove('hidden'); loadAkademik('Materi'); el('navBotAkd').className = "flex flex-col items-center w-16 text-fuchsia-600 transition active:scale-95"; }
    else if(page==='nilaiGuru'){ el('viewNilaiGuru').classList.remove('hidden'); el('navBotKhusus').className = "flex flex-col items-center w-16 text-fuchsia-600 transition active:scale-95"; }
    else if(page==='nilaiSiswa'){ el('viewNilaiSiswa').classList.remove('hidden'); loadLeaderboard(); }
    else if(page==='mading'){ el('viewMading').classList.remove('hidden'); loadMading(); el('navBotKhusus').className = "flex flex-col items-center w-16 text-fuchsia-600 transition active:scale-95"; }
    else if(page==='perpus'){ el('viewPerpus').classList.remove('hidden'); loadPerpus(); loadKaldik(); } 
    else if(page==='profil'){ el('viewProfil').classList.remove('hidden'); }
    else if(page==='berita'){ el('viewBerita').classList.remove('hidden'); loadBerita(); }
}
function navToMenuKhusus(){ if(USER.role === 'guru' || USER.role === 'admin') navTo('nilaiGuru'); else navTo('mading'); }

function loadHome(){
    fetch(`${API_URL}?action=home`).then(r=>r.json()).then(d=>{
        el('infoNama').innerText = d.info.nama; el('infoAlamat').innerText = d.info.alamat;
        el('infoOperator').innerText = d.info.operator; el('infoEmail').innerText = d.info.email; el('infoWeb').innerText = d.info.web;
        window.CACHE_BERITA = d.pengumuman; el('listPengumuman').innerHTML = renderBerita(d.pengumuman);
    });
}
function loadKaldik(){
    el('listKaldik').innerHTML = "<div class='text-center py-4'><i class='fas fa-circle-notch fa-spin text-fuchsia-500'></i></div>";
    fetch(`${API_URL}?action=perpus`).then(r=>r.json()).then(d=>{
        const kaldik = d.data.filter(item => item.kategori === 'Kaldik' || item.kategori === 'kaldik');
        if(kaldik.length){
            el('listKaldik').innerHTML = kaldik.map(i => {
                const linkContent = i.link || '';
                if(linkContent.trim().startsWith('<')) return `<div class="bg-white p-3 rounded-xl border border-fuchsia-100 mb-2"><h4 class="font-bold text-sm text-slate-800 mb-2">${i.judul}</h4><div class="embed-container">${linkContent}</div></div>`;
                return `<a href="${linkContent}" target="_blank" class="block bg-white p-3 rounded-xl border border-fuchsia-100 flex gap-3 items-center hover:bg-fuchsia-50"><div class="w-10 h-10 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center"><i class="fas fa-calendar-check"></i></div><div><h4 class="font-bold text-sm text-slate-800">${i.judul}</h4><p class="text-xs text-slate-500">Lihat Kalender</p></div></a>`;
            }).join('');
        } else { el('listKaldik').innerHTML = `<div class="text-center py-4 border-2 border-dashed border-slate-200 rounded-xl text-xs text-slate-400">Belum ada info Kaldik.</div>`; }
    });
}
function loadBerita(){ el('listBerita').innerHTML = renderBerita(window.CACHE_BERITA || []); }
function renderBerita(data){ return data.map(p => `<div class="bg-white p-4 rounded-xl border-l-4 border-blue-400 shadow-sm"><span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-0.5 rounded">${p.tanggal}</span><h4 class="font-bold text-sm text-slate-800 mt-1">${p.judul}</h4><p class="text-xs text-slate-500 mt-1">${p.isi}</p></div>`).join('') || "<p class='text-center text-xs text-slate-400'>Tidak ada pengumuman.</p>"; }

// FILTERING TOMBOL AKADEMIK
function filterAkademik(tipe, btnId){ 
    // Reset all buttons
    document.querySelectorAll('#viewAkademik button.px-4').forEach(b => {
        b.className = "px-4 py-2 rounded-xl bg-white border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition whitespace-nowrap shadow-sm";
    });
    // Set active
    if(btnId) document.getElementById(btnId).className = "px-4 py-2 rounded-xl bg-fuchsia-600 border border-fuchsia-600 text-xs font-bold text-white shadow-md transform scale-105 transition whitespace-nowrap";
    loadAkademik(tipe); 
}

function loadAkademik(tipe){
    el('listAkademik').innerHTML = "<div class='text-center py-10'><i class='fas fa-circle-notch fa-spin text-fuchsia-500'></i></div>";
    fetch(`${API_URL}?action=akademik&kelas=${USER.kelas}&role=${USER.role}`).then(r=>r.json()).then(d=>{
        const filtered = d.data.filter(item => item.tipe === tipe);
        if(filtered.length){
            el('listAkademik').innerHTML = filtered.map(i => {
                const linkContent = i.konten || i.link || '';
                const canDelete = (USER.email === i.uploader || USER.role === 'admin') ? `<button onclick="deleteAkademik('${i.id}')" class="text-red-500 text-xs font-bold hover:underline ml-2">[Hapus]</button>` : '';

                if(linkContent.trim().startsWith('<') || linkContent.includes('<iframe') || linkContent.includes('<div')) {
                    const safeHtml = linkContent.replace(/'/g, "&apos;");
                    return `<div class="bg-white p-4 rounded-xl border border-fuchsia-100 shadow-sm mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wide bg-slate-50 px-1 rounded">${i.mapel} ${canDelete}</span>
                            <span class="text-[9px] font-bold text-red-500">${i.deadline||''}</span>
                        </div>
                        <h4 class="font-bold text-slate-800 text-sm mb-2">${i.judul}</h4>
                        <div class="game-viewer">
                            <iframe srcdoc='${safeHtml}' sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
                        </div>
                    </div>`;
                }
                return `<div class="block bg-white p-4 rounded-xl border border-fuchsia-100 shadow-sm hover:border-fuchsia-400 transition relative overflow-hidden group"><div class="absolute top-0 right-0 bg-fuchsia-50 text-fuchsia-600 text-[9px] px-2 py-1 rounded-bl-lg font-bold">${i.deadline || ''}</div><div class="flex items-center gap-3"><a href="${linkContent}" target="_blank" class="w-10 h-10 bg-fuchsia-50 text-fuchsia-600 rounded-full flex items-center justify-center group-hover:bg-fuchsia-600 group-hover:text-white transition"><i class="fas fa-book-open"></i></a><div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-wide bg-slate-50 px-1 rounded">${i.mapel} ${canDelete}</span><h4 class="font-bold text-slate-800 text-sm leading-tight mt-0.5"><a href="${linkContent}" target="_blank">${i.judul}</a></h4></div></div></div>`;
            }).join('');
        } else { el('listAkademik').innerHTML = `<div class="text-center py-10 text-slate-400 text-xs border-2 border-dashed border-fuchsia-100 rounded-xl">Belum ada konten ${tipe}</div>`; }
    });
}
function showModalUpload(){ el('modalUpload').classList.remove('hidden'); }
function submitAkademik(){
    const htmlVal = el('upHtml').value;
    const linkVal = el('upLink').value;
    const p = { action: 'simpan_akademik', uploader: USER.email, tipe: el('upTipe').value, kelas: el('upKelas').value, mapel: el('upMapel').value, judul: el('upJudul').value, link: linkVal, htmlContent: htmlVal, deadline: el('upDead').value };
    if(!p.judul) return alert("Judul wajib diisi!");
    if(!htmlVal && !linkVal) return alert("Isi Link URL atau Paste Kode HTML!");
    el('btnSimpanAkd').innerText = "...";
    fetch(API_URL, {method:'POST', body:JSON.stringify(p)}).then(r=>r.json()).then(d=>{ el('btnSimpanAkd').innerText = "Simpan"; alert(d.message); el('modalUpload').classList.add('hidden'); loadAkademik(p.tipe); });
}
function deleteAkademik(id){
    if(confirm("Hapus konten ini?")){
        const p = { action: 'hapus_akademik', id: id, email: USER.email, role: USER.role };
        fetch(API_URL, {method:'POST', body:JSON.stringify(p)}).then(r=>r.json()).then(d=>{
            alert(d.message); if(d.status) loadAkademik('Materi'); 
        });
    }
}
function loadSiswaDropdown(){ const k = el('inKelas').value; if(!k) return alert("Isi kelas!"); el('inSiswa').innerHTML = "<option>Memuat...</option>"; fetch(`${API_URL}?action=getSiswa&kelas=${k}`).then(r=>r.json()).then(d=>{ el('inSiswa').innerHTML = d.data.map(s => `<option value="${s.email}">${s.nama}</option>`).join(''); }); }
function submitNilai(){ const p = { action: 'simpan_nilai', email: el('inSiswa').value, kategori: el('inKategori').value, mapel: el('inMapel').value, judul: el('inJudul').value, nilai: el('inNilai').value, catatan: el('inCatatan').value }; if(!p.email || !p.nilai) return alert("Data kurang lengkap"); el('btnSimpanNilai').innerText = "..."; fetch(API_URL, {method:'POST', body:JSON.stringify(p)}).then(r=>r.json()).then(d=>{ el('btnSimpanNilai').innerText = "SIMPAN NILAI"; alert(d.message); }); }
function loadLeaderboard(){ fetch(`${API_URL}?action=leaderboard&kelas=${USER.kelas}`).then(r=>r.json()).then(d=>{ const top3 = d.data; if(top3.length){ el('top3Container').innerHTML = `${top3[1] ? `<div class="text-center w-1/3"><i class="fas fa-medal text-3xl medal-2"></i><p class="text-[10px] font-bold mt-1 truncate text-white">${top3[1].nama}</p><p class="text-xs font-bold text-fuchsia-200">${top3[1].rata}</p></div>` : ''}<div class="text-center w-1/3 mb-6"><i class="fas fa-medal text-5xl medal-1 animate-bounce"></i><p class="text-xs font-bold text-yellow-300 mt-1 truncate">${top3[0].nama}</p><span class="text-xs font-bold bg-white text-slate-900 px-2 rounded-full shadow-lg">${top3[0].rata}</span></div>${top3[2] ? `<div class="text-center w-1/3"><i class="fas fa-medal text-3xl medal-3"></i><p class="text-[10px] font-bold mt-1 truncate text-white">${top3[2].nama}</p><p class="text-xs font-bold text-fuchsia-200">${top3[2].rata}</p></div>` : ''}`; } else { el('top3Container').innerHTML = "<p class='text-xs opacity-50 text-white'>Belum ada data</p>"; } }); fetch(`${API_URL}?action=nilai&email=${USER.email}`).then(r=>r.json()).then(d=>{ el('riwayatNilai').innerHTML = d.data.map(n => `<div class="bg-white p-3 rounded-xl border border-fuchsia-50 flex justify-between items-center shadow-sm"><div><span class="text-[9px] font-bold bg-fuchsia-50 text-fuchsia-600 px-2 py-0.5 rounded uppercase">${n.kategori} ‚Ä¢ ${n.mapel}</span><h4 class="font-bold text-sm mt-1 text-slate-700">${n.judul}</h4></div><div class="text-lg font-bold ${n.nilai>=75?'text-green-600':'text-red-500'}">${n.nilai}</div></div>`).join(''); }); }
function loadMading(){ fetch(`${API_URL}?action=leaderboard&kelas=${USER.kelas}`).then(r=>r.json()).then(d=>{ const top = d.data[0]; el('madingJuara').innerText = top ? `üèÜ ${top.nama} (Rata-rata: ${top.rata})` : "Belum ada juara."; }); el('madingInfo').innerHTML = renderBerita(window.CACHE_BERITA || []); }
function loadPerpus(){ el('listPerpus').innerHTML = "Memuat..."; fetch(`${API_URL}?action=perpus`).then(r=>r.json()).then(d=>{ 
    const books = d.data.filter(item => item.kategori !== 'Kaldik');
    el('listPerpus').innerHTML = books.map(b => `<a href="${b.link}" target="_blank" class="block bg-white p-4 rounded-xl border border-fuchsia-100 text-center hover:shadow-md transition"><i class="fas fa-book-reader text-3xl text-fuchsia-400 mb-2"></i><h4 class="font-bold text-xs line-clamp-2 text-slate-700">${b.judul}</h4><span class="text-[10px] text-slate-400 bg-slate-50 px-2 rounded mt-1 inline-block">${b.kategori}</span></a>`).join(''); 
}); }
function updateFotoGuru(){ const url = document.getElementById('urlFotoGuru').value; if(!url) return; el('btnSaveFoto').innerText = "..."; const payload = { action: 'update_foto', email: USER.email, foto: url }; fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(d=>{ el('btnSaveFoto').innerText = "Simpan"; if(d.status){ alert("Foto berhasil diperbarui!"); USER.foto = url; localStorage.setItem('lmsUserV4', JSON.stringify(USER)); el('headImg').src = url; el('profilImg').src = url; } else { alert("Gagal update foto."); } }); }
</script>
</body>
</html>